<html>

<head>
<meta charset="UTF-8">
<title>data monitor</title>

<script src="jquery.min.js"></script>
<script src="Chart.min.js"></script>

</head>
<body>
        <div style="width:60%;">
                <canvas id="myChart"></canvas>
        </div>
                <div>

                        <button id="start">Start</button>
                        <button id="stop">Stop</button>
                        <span id="counter"></span>
                </div>
<div id="output">
</div>
</body>
<script language="javascript" type="text/javascript">
    var wsUri ="ws://localhost:8081/";
    var output;
    var counter = 0;

window.chartColors = {
        red: 'rgb(255, 99, 132)',
        orange: 'rgb(255, 159, 64)',
        yellow: 'rgb(255, 205, 86)',
        green: 'rgb(75, 192, 192)',
        blue: 'rgb(54, 162, 235)',
        purple: 'rgb(153, 102, 255)',
        grey: 'rgb(201, 203, 207)'
};


        Chart.defaults.global.animation = false;



    var ctx = document.getElementById("myChart").getContext("2d");
//var MONTHS = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                var config = {
                        type: 'line',
                        data: {
                                labels: ['', '', '', '', '', '', ''],
                                datasets: [{
                                        label: 'Channel1',
                                        backgroundColor: window.chartColors.red,
                                        borderColor: window.chartColors.red,
                                        data: [
                                                0,
                                                0,
                                                0,
                                                0,
                                                0,
                                                0,
                                                0
                                        ],
                                        fill: false,
                                }, {
                                        label: 'Channel2',
                                        fill: false,
                                        backgroundColor: window.chartColors.blue,
                                        borderColor: window.chartColors.blue,
                                        data: [
                                                0,
                                                0,
                                                0,
                                                0,
                                                0,
                                                0,
                                                0
                                        ],
                                }, {
                                        label: 'Channel3',
                                        fill: false,
                                        backgroundColor: window.chartColors.yellow,
                                        borderColor: window.chartColors.yellow,
                                        data: [
                                                0,
                                                0,
                                                0,
                                                0,
                                                0,
                                                0,
                                                0
                                        ],
                                }, {
                                        label: 'Channel4',
                                        fill: false,
                                        backgroundColor: window.chartColors.green,
                                        borderColor: window.chartColors.green,
                                        data: [
                                                0,
                                                0,
                                                0,
                                                0,
                                                0,
                                                0,
                                                0
                                        ],
                                }, {
                                        label: 'Channel5',
                                        fill: false,
                                        backgroundColor: window.chartColors.yellow,
                                        borderColor: window.chartColors.yellow,
                                        data: [
                                                0,
                                                0,
                                                0,
                                                0,
                                                0,
                                                0,
                                                0
                                        ],
                                }, {
                                        label: 'Channel6',
                                        fill: false,
                                        backgroundColor: window.chartColors.blue,
                                        borderColor: window.chartColors.blue,
                                        data: [
                                                0,
                                                0,
                                                0,
                                                0,
                                                0,
                                                0,
                                                0
                                        ],
                                }, {
                                        label: 'Channel7',
                                        fill: false,
                                        backgroundColor: window.chartColors.red,
                                        borderColor: window.chartColors.red,
                                        data: [
                                                0,
                                                0,
                                                0,
                                                0,
                                                0,
                                                0,
                                                0
                                        ],
                                }, {
                                        label: 'Channel8',
                                        fill: false,
                                        backgroundColor: window.chartColors.purple,
                                        borderColor: window.chartColors.purple,
                                        data: [
                                                0,
                                                0,
                                                0,
                                                0,
                                                0,
                                                0,
                                                0
                                        ],
                                }]
                        },
                        options: {
                                responsive: true,
                                title: {
                                        display: true,
                                        text: 'Modbus Data Acquire'
                                },
                                tooltips: {
                                        mode: 'index',
                                        intersect: false,
                                },
                                hover: {
                                        mode: 'nearest',
                                        intersect: true
                                },
                                scales: {
                                        xAxes: [{
                                                display: true,
                                                scaleLabel: {
                                                        display: true,
                                                        labelString: 'Time'
                                                }
                                        }],
                                        yAxes: [{
                                                display: true,
                                                scaleLabel: {
                                                        display: true,
                                                        labelString: 'Value'
                                                }
                                        }]
                                }
                        }
                };

    window.myLine = new Chart(ctx, config);

    function init() {
        output = document.getElementById("output");
        connectWebSocket();
    }

    function connectWebSocket() {
        websocket = new WebSocket(wsUri);
        websocket.onopen = function(evt) {
            onOpen(evt)
        };
        websocket.onclose = function(evt) {
            onClose(evt)
        };
        websocket.onmessage = function(evt) {
            onMessage(evt)
        };
        websocket.onerror = function(evt) {
            onError(evt)
        };
    }

    function onOpen(evt) {
        writeToScreen("CONNECTED");
        doSend("WebSocket rocks");
    }

    function onClose(evt) {
        writeToScreen("DISCONNECTED");
    }

    var updateCounter = 0;
    function onMessage(evt) {
                //console.log(evt);
                if(!evt.data)
                        return;
                counter++;
                $("#counter").html("Received "+counter+" Messages");
                debugger;
                var data = JSON.parse(evt.data);
                if(config.data.datasets.length > data.channel){
                        config.data.datasets[data.channel].data.push(data.value);
                        if(config.data.datasets[data.channel].data.length>7)
                                config.data.datasets[data.channel].data.shift();

                updateCounter = ++updateCounter%8;
                if( updateCounter == 0)
                    window.myLine.update();// = new Chart(ctx, config);
                }

        //writeToScreen('<span style="color: blue;">RESPONSE: '+ evt.data+'</span>');
        //websocket.close();
    }

    function onError(evt) {
        writeToScreen('<span style="color: red;">ERROR:</span> '+ evt.data);
    }

    function doSend(message) {
        writeToScreen("SENT: " + message);
        websocket.send(message);
    }

    function writeToScreen(message) {
        var pre = document.createElement("p");
        pre.style.wordWrap = "break-word";
        pre.innerHTML = message;
        output.appendChild(pre);
    }

    window.addEventListener("load", init, false);


$("#start").click(function(){
$.get("/modbusda/start");
});


$("#stop").click(function(){
$.get("/modbusda/stop");
});

</script>
</html
